<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Chatbot Klungkung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Layout dasar: sidebar kiri + area chat utama + FAQ/input fixed di bawah (desktop) */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Montserrat", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: #e7f0ff;
      min-height: 100vh;
    }

    /* Widget mode (mini popup) */
    html.widget,
    body.widget {
      background: transparent;
      height: 100%;
    }

    body.widget {
      min-height: auto;
      overflow: hidden;
    }

    body.widget .page {
      position: relative;
      height: 100%;
      min-height: 100%;
      padding: 12px 12px 128px;
      gap: 0;
      align-items: stretch;
    }

    body.widget .sidebar {
      display: none;
    }

    body.widget .main {
      padding: 8px 0 0;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    body.widget .language-switcher {
      position: static;
      margin: 0 auto 8px;
      justify-content: center;
    }

    body.widget .chat-back-btn {
      display: none;
    }

    body.widget .chat-topbar {
      position: static;
      background: transparent;
      backdrop-filter: none;
      padding: 0;
      justify-content: center;
    }

    body.widget .welcome-text {
      position: static;
      flex: 1;
      padding-top: 0;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body.widget .welcome-text-masked {
      font-size: 22px;
      max-width: 100%;
    }

    body.widget .chat-column {
      max-width: 100%;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    body.widget #chatTopTitle {
      display: none;
    }

    body.widget .chat-content {
      display: flex;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 12px;
    }

    body.widget .faq-area {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(231, 240, 255, 0.95);
      padding: 8px 12px 14px;
      min-height: 116px;
      border-top: 1px solid rgba(207, 214, 234, 0.8);
    }

    body.widget .faq-inner {
      max-width: 100%;
    }

    body.widget .hint-text {
      display: none;
    }

    body.widget .faq-chips {
      margin-bottom: 8px;
      gap: 6px;
    }

    body.widget .chip {
      padding: 5px 10px;
      font-size: 10px;
    }

    body.widget .input-row {
      padding: 6px 8px 6px 16px;
      gap: 8px;
      margin-bottom: 6px;
    }

    body.widget .input-row input {
      font-size: 12px;
      padding: 4px 0;
    }

    body.widget .send-btn {
      width: 34px;
      height: 34px;
      font-size: 16px;
    }

    .page {
      display: flex;
      min-height: 100vh;
      padding: 16px 32px;
      gap: 40px;
      align-items: flex-start;
    }

    /* SIDEBAR */
    .sidebar {
      width: 320px;
      background: #ffffff;
      border-radius: 32px;
      padding: 28px 26px 24px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 16px;
      height: calc(100vh - 32px);
    }

    .sidebar-header {
      text-align: center;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 26px;
    }

    .btn-primary {
      border: none;
      outline: none;
      border-radius: 999px;
      background: #008ddc;
      color: #ffffff;
      padding: 10px 18px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s;
      box-shadow: 0 6px 16px rgba(0,102,204,0.25);
    }
    .btn-primary:hover {
      opacity: 0.96;
      transform: translateY(-1px);
    }

    .sidebar-section-title {
      font-size: 11px;
      color: #8b8b99;
      margin: 18px 0 8px;
    }

    .sidebar-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .mobile-history-toggle {
      display: none;
      border: 1px solid #cfd6ea;
      background: #ffffff;
      color: #2a3558;
      border-radius: 14px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(2,6,23,0.08);
    }

    .conversation-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .conversation-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      cursor: pointer;
      font-size: 13px;
      color: #333;
      transition: background 0.15s ease, box-shadow 0.15s ease;
    }

    .conversation-item:hover {
      background: #f0f4ff;
    }

    .conversation-item.active {
      background: #e1ecff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    .conv-icon {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 1.5px solid #a7b7ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      color: #6471a8;
      background: #f6f7ff;
      flex-shrink: 0;
    }

    .sidebar-footer {
      margin-top: 22px;
      border-top: 1px solid #edf0ff;
      padding-top: 12px;
      font-size: 12px;
      color: #666;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-footer-item {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .footer-icon {
      font-size: 13px;
    }

    /* MAIN AREA */
    .main {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 26px 0 18px;
    }

    .welcome-text {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 200px;
      pointer-events: none;
    }

    .welcome-inner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      width: 100%;
    }

    /* REPLACED IMAGE WITH TEXT MASKING */
    .welcome-text-masked {
      font-size: 48px;
      font-weight: 800;
      text-align: center;
      /* Ganti baris di bawah ini dengan link baru Anda */
      background: url('https://i.ibb.co.com/x87S5ZQM/peter-chen-Re-meh-WVo-A-unsplash.jpg') center/cover no-repeat;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent; 
      max-width: 800px;
      line-height: 1.2;
      padding: 0 20px;
    }

    /* ===== KOLUM CHAT (wrapper) ===== */
    .chat-column {
      max-width: 880px;
      width: 100%;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    /* CHAT TITLE (atas: User 1 / Chatbot Klungkung) */
    .answer-heading {
      font-size: 18px;
      font-weight: 600;
    }

    /* CHAT CONTENT (isi percakapan) */
    .chat-content {
      display: none;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 18px;
      width: 100%;
      padding-bottom: 200px; /* ruang agar tidak ketutupan bar bawah */
    }

    .message-row {
      display: flex;
      margin-bottom: 4px;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-row.assistant {
      justify-content: flex-start;
      margin-bottom: 10px; /* sedikit jarak antar jawaban AI */
    }

    .message-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 13px;
      line-height: 1.6;
    }

    .message-bubble.user {
      background: #008ddc;
      color: #ffffff;
      border-bottom-right-radius: 4px;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }

    .message-bubble.assistant {
      background: #ffffff;
      color: #222222;
      border-bottom-left-radius: 4px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.06);
      margin-bottom: 8px;      /* jarak sebelum feedback bar */
      white-space: pre-line;   /* üî• pake \n jadi enter/paragraf */
      text-align: left;
    }

    .message-bubble.typing {
      min-width: 56px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
    }

    .typing-dots {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      justify-content: center;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #6e7aa8;
      opacity: 0.3;
      animation: typingPulse 1.2s infinite ease-in-out;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes typingPulse {
      0%, 80%, 100% {
        opacity: 0.25;
        transform: translateY(0);
      }
      40% {
        opacity: 1;
        transform: translateY(-2px);
      }
    }

    /* FEEDBACK BAR DI BAWAH JAWABAN AI */
    .feedback-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #8b96b3;
      margin: 4px 0 18px 6px; /* jarak atas & bawah dirapihin */
    }

    .feedback-divider {
      width: 1px;
      height: 16px;
      background: #cfd6ea;
    }

    .feedback-icon {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2px 4px;
      border-radius: 4px;
      color: #8b96b3;
      transition: color 0.12s ease, background 0.12s ease;
    }

    .feedback-icon:hover {
      background: #e4ecff;
    }

    .feedback-icon.active {
      color: #008ddc;
    }

    /* FAQ & INPUT - FIXED BOTTOM (hanya area tengah, tidak nutup sidebar) */
    .faq-area {
      width: auto;
      position: fixed;
      bottom: 0;                         /* nempel ke bawah, tanpa space */
      left: 392px;                       /* 32 (padding) + 320 (sidebar) + 40 (gap) */
      right: 32px;
      background: rgba(231, 240, 255, 0.5); /* ~50% opacity */
      backdrop-filter: blur(8px);           /* blur halus */
      padding: 8px 0 16px;
      z-index: 5;
    }

    .faq-inner {
      max-width: 880px;
      margin: 0 auto;
    }

    .faq-header {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: #999;
      margin-bottom: 6px;
    }

    .faq-line {
      flex: 1;
      border: none;
      border-top: 1px solid #cfd6ea;
    }

    .faq-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      justify-content: center;
    }

    .chip {
      border-radius: 999px;
      border: 1px solid #d8e4ff;
      background: #ffffff;
      padding: 7px 14px;
      font-size: 11px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
      white-space: nowrap;
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }

    .chip:hover {
      background: #edf3ff;
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.06);
    }

    .input-row {
      width: 100%;
      background: #ffffff; /* bubble tetap solid */
      border-radius: 999px;
      padding: 8px 10px 8px 22px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 6px 26px rgba(0,0,0,0.12);
      transition: box-shadow 0.15s ease, transform 0.15s ease;
    }

    .input-row:focus-within {
      box-shadow: 0 8px 28px rgba(0,0,0,0.18);
    }

    .input-row input {
      flex: 1;
      border: none;
      outline: none;
      font-size: 14px;
      padding: 6px 0;
      background: transparent;
    }

    .send-btn {
      border-radius: 999px;
      width: 40px;
      height: 40px;
      border: none;
      background: #0090df;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 19px;
      box-shadow: 0 5px 15px rgba(0,102,204,0.4);
      transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s ease;
    }

    .send-btn:hover {
      opacity: 0.95;
      transform: translateY(-0.5px);
    }

    .send-btn:active {
      transform: scale(0.96);
    }

    .hint-text {
      margin-top: 6px;
      font-size: 11px;
      color: #9aa1b2;
      text-align: right;
    }

    /* SETTINGS OVERLAY */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(246, 249, 255, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .settings-modal {
      width: 640px;
      height: 360px;
      background: #ffffff;
      border-radius: 26px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
      display: flex;
      overflow: hidden;
    }

    .settings-left {
      width: 140px;
      background: #e5eeff;
      padding: 18px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .settings-tab {
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .settings-tab.active {
      background: #ffffff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.04);
    }

    .settings-tab-icon {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid #7a8bdc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      background: #f1f3ff;
      color: #5b67a4;
    }

    .settings-right {
      flex: 1;
      background: #e5eeff;
      padding: 18px 22px;
      display: flex;
      flex-direction: column;
    }

    .settings-heading {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .settings-divider {
      border: none;
      border-top: 1px solid #bcc9e5;
      margin-bottom: 18px;
    }
    .settings-lang-label {
      font-size: 12px;
      color: #5a6078;
      margin-bottom: 10px;
    }

    .settings-lang-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .settings-lang-btn {
      border: 1px solid #b8c6e6;
      background: #ffffff;
      color: #2a3558;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .settings-lang-btn.active {
      background: #1f2a44;
      color: #ffffff;
      border-color: #1f2a44;
    }

    .close-overlay {
      align-self: flex-end;
      margin-top: auto;
      font-size: 11px;
      color: #6b6b7e;
      cursor: pointer;
    }

    @media (max-width: 900px) {
      .page {
        flex-direction: column;
        padding: 12px 14px;
      }
      .sidebar {
        position: static;
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border-radius: 22px;
        height: auto;
        flex-wrap: wrap;
      }
      .sidebar-header {
        margin-bottom: 0;
        flex: 1 1 auto;
      }
      .sidebar-actions {
        flex: 1 1 100%;
        justify-content: space-between;
      }
      .mobile-history-toggle {
        display: inline-flex;
      }
      .conversation-list {
        max-height: 120px;
        display: none;
        width: 100%;
      }
      .conversation-list.open {
        display: flex;
      }
      .sidebar-section-title {
        display: none;
      }
      .main {
        padding-top: 12px;
      }
      /* Adjusted for text masking */
      .welcome-text-masked {
        font-size: 32px;
      }
      .chat-column {
        max-width: 100%;
      }
      .chat-content {
        padding-bottom: 160px;
      }
      .faq-area {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(231, 240, 255, 0.98);
        backdrop-filter: blur(8px);
        padding: 10px 12px 14px;
        z-index: 12;
      }
      .faq-inner {
        max-width: 100%;
      }
      .chat-title-card {
        position: static;
        box-shadow: none;
        border-radius: 0;
        background: transparent;
        padding: 6px 0 10px;
      }
      .chat-topbar {
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px 12px;
      }
      .chat-back-btn {
        order: 1;
      }
      #chatTopTitle {
        order: 2;
        width: 100%;
        text-align: center;
        font-size: 16px;
      }
      .language-switcher {
        order: 3;
      }
    }
    /* TOP BAR (back + language) */
      .chat-topbar {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 10px 0 6px;
        background: rgba(231, 240, 255, 0.9);
        backdrop-filter: blur(6px);
      }

      .language-switcher {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 20px;
        padding: 6px 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }

      .language-switcher button {
        border: none;
        outline: none;
        background: transparent;
        font-size: 13px;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 12px;
        transition: all 0.15s ease;
      }

      .language-switcher button.active {
        background: #008ddc;
        color: white;
      }

      .language-switcher button:hover:not(.active) {
        background: #e7f0ff;
    }

    .chat-back-btn {
      border: none;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.85);
      color: #1f2a44;
      font-size: 13px;
      font-weight: 600;
      padding: 6px 12px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: background 0.15s ease;
    }

    .chat-back-btn:hover {
      background: #ffffff;
    }

    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>
<body>
  <script>
    /* Widget mode toggle based on query param */
    const isWidget = new URLSearchParams(window.location.search).get("widget") === "1";
    if (isWidget) {
      document.documentElement.classList.add("widget");
      document.body.classList.add("widget");
    }
  </script>
  <div class="page">
    <aside class="sidebar">
      <div class="sidebar-header">Chatbot Klungkung</div>

      <div class="sidebar-actions">
        <button class="btn-primary" id="newChatBtn">+ Chat baru</button>
        <button class="mobile-history-toggle" id="historyToggleBtn">‚â°</button>
      </div>

      <div class="sidebar-section-title">Chat terakhir</div>
      <div class="conversation-list" id="conversationList">
        </div>

      <div class="sidebar-footer">
        <div class="sidebar-footer-item" id="settingsBtn">
          <span class="footer-icon">‚öôÔ∏è</span>
          <span>Pengaturan</span>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="chat-topbar">
        <button class="chat-back-btn" id="chatBackBtn">&lt; Kembali</button>
        <div class="answer-heading" id="chatTopTitle">Chatbot Klungkung</div>
        <div class="language-switcher">
          <button id="lang-id" class="active">ID</button>
          <button id="lang-en">EN</button>
        </div>
      </div>
      <div class="welcome-text" id="welcomeSection">
        <div class="welcome-inner">
          <h1 class="welcome-text-masked">
            Selamat Datang di Chatbot Wisata Kabupaten Klungkung
          </h1>
        </div>
      </div>

      <div class="chat-column">
        <div class="chat-content" id="chatContent">
          </div>
      </div>
    </main>
  </div>

  <section class="faq-area">
    <div class="faq-inner">
      <div class="faq-header">
        <span>FAQ</span>
        <hr class="faq-line" />
      </div>

      <div class="faq-chips" id="faqChips">
        <button class="chip">Rute Utama Wisata</button>
        <button class="chip">Pesawat Menuju Klungkung</button>
        <button class="chip">Wisata Kabupaten Klungkung</button>
        <button class="chip">Transportasi Umum</button>
      </div>

      <form class="input-row" id="chatForm">
        <input
          id="userInput"
          type="text"
          placeholder="Tanyakan apa saja tentang wisata di Kabupaten Klungkung..."
          autocomplete="off"
        />
        <button type="submit" class="send-btn" title="Kirim">
          ‚û§
        </button>
      </form>

      <div class="hint-text">
        Tekan Enter untuk mengirim pesan
      </div>
    </div>
  </section>

  <div class="overlay" id="settingsOverlay">
    <div class="settings-modal">
      <div class="settings-left">
        <div class="settings-tab active">
          <div class="settings-tab-icon">L</div>
          <span id="settingsTabLabel">Bahasa</span>
        </div>
      </div>
      <div class="settings-right">
        <div class="settings-heading" id="settingsHeading">Bahasa</div>
        <hr class="settings-divider" />
        <div class="settings-lang-label" id="settingsLangLabel">Pilih bahasa</div>
        <div class="settings-lang-group">
          <button class="settings-lang-btn active" id="settingsLangId">Indonesia</button>
          <button class="settings-lang-btn" id="settingsLangEn">English</button>
        </div>

        <div class="close-overlay" id="closeSettings">
          Tutup
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ===== KONFIGURASI API ===== */
    const USE_MOCK = false; // ubah ke true kalau mau demo tanpa backend
    const API_URL = "https://chatbot-klungkung-production.up.railway.app/"; // endpoint backend 

    /* DOM references (UI critical) */
    const welcomeSection = document.getElementById("welcomeSection");
    const chatContent = document.getElementById("chatContent");
    const conversationList = document.getElementById("conversationList");
    const chatForm = document.getElementById("chatForm");
    const userInput = document.getElementById("userInput");
    const faqChips = document.getElementById("faqChips");

    const settingsBtn = document.getElementById("settingsBtn");
    const settingsOverlay = document.getElementById("settingsOverlay");
    const closeSettings = document.getElementById("closeSettings");
    const newChatBtn = document.getElementById("newChatBtn");
    const historyToggleBtn = document.getElementById("historyToggleBtn");

    /* Struktur state percakapan:
        conversations = array sesi [{ title, messages: [{role, content}] }]
        activeConversationIndex = indeks sesi yang sedang dibuka */
    let conversations = [];
    let activeConversationIndex = null;

    function showChatSection() {
      /* UX: toggle from welcome to chat */
      welcomeSection.style.display = "none";
      chatContent.style.display = "flex";
    }

    /* Render daftar sesi chat di sidebar */
    function renderConversationList() {
      /* UI: rebuild conversation list */
      conversationList.innerHTML = "";

      conversations.forEach((conv, index) => {
        const item = document.createElement("div");
        item.className = "conversation-item" + (index === activeConversationIndex ? " active" : "");
        item.dataset.index = index;

        item.innerHTML = `
          <div class="conv-icon">üí¨</div>
          <div>${conv.title || "Chat baru"}</div>
        `;

        conversationList.appendChild(item);
      });
    }

    /* Tambah bubble pesan ke UI */
    function addMessageToUI(role, content, options = {}) {
      /* UI: add message bubble to chat column */
      const { typing = false, skipScroll = false } = options;

      const row = document.createElement("div");
      row.className = "message-row " + role;

      const bubble = document.createElement("div");
      bubble.className = "message-bubble " + role;

      if (typing) {
        bubble.classList.add("typing");
        bubble.innerHTML = `
          <span class="typing-dots" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
          </span>
        `;
      } else {
        bubble.textContent = content;
      }

      row.appendChild(bubble);
      chatContent.appendChild(row);

      if (!skipScroll) {
        /* UX: keep latest message in view */
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth"
        });
      }

      return bubble;
    }

    /* Tambah bar feedback (like/dislike/copy) di bawah jawaban AI */
    function createFeedbackRow(afterRowElement, answerText) {
      /* UI: feedback controls below assistant message */
      const wrapper = document.createElement("div");
      wrapper.className = "feedback-row";

      wrapper.innerHTML = `
        <div class="feedback-icon feedback-like" title="Suka">&#128077;</div>
        <div class="feedback-icon feedback-dislike" title="Tidak suka">&#128078;</div>
        <div class="feedback-divider"></div>
        <div class="feedback-icon feedback-copy" title="Salin jawaban">&#128203;</div>
      `;

      chatContent.insertBefore(wrapper, afterRowElement.nextSibling);

      const likeBtn = wrapper.querySelector(".feedback-like");
      const dislikeBtn = wrapper.querySelector(".feedback-dislike");
      const copyBtn = wrapper.querySelector(".feedback-copy");

      likeBtn.addEventListener("click", () => {
        /* Event: toggle like */
        likeBtn.classList.toggle("active");
        if (likeBtn.classList.contains("active")) {
          dislikeBtn.classList.remove("active");
        }
      });

      dislikeBtn.addEventListener("click", () => {
        /* Event: toggle dislike */
        dislikeBtn.classList.toggle("active");
        if (dislikeBtn.classList.contains("active")) {
          likeBtn.classList.remove("active");
        }
      });

      copyBtn.addEventListener("click", () => {
        /* Event: copy answer text */
        navigator.clipboard.writeText(answerText || "").catch(() => {});
        copyBtn.classList.add("active");
        setTimeout(() => copyBtn.classList.remove("active"), 500);
      });
    }

    /* Efek ketik per karakter untuk jawaban */
    function typeText(element, fullText, afterTypeCallback) {
      /* Typing effect for assistant reply */
      element.textContent = "";
      let index = 0;
      const speed = 10; // ms per karakter

      const interval = setInterval(() => {
        element.textContent += fullText.charAt(index);
        index++;
        if (index >= fullText.length) {
          clearInterval(interval);
          if (typeof afterTypeCallback === "function") {
            afterTypeCallback();
          }
        }
      }, speed);
    }

    /* Konversi HTML ke teks polos (untuk konsistensi bubble) */
    function toPlainText(maybeHtml) {
      /* Safety: strip HTML */
      const temp = document.createElement("div");
      temp.innerHTML = maybeHtml;
      return (temp.textContent || temp.innerText || "").trim();
    }

    /* Panggil backend chat */
    async function callChatApi(message) {
      /* API call to backend or mock */
      if (USE_MOCK) {
        // contoh jawaban mock kalau belum punya backend
        return new Promise((resolve) => {
          setTimeout(() => {
            resolve({ answer: "Ini jawaban contoh untuk pertanyaan: " + message });
          }, 400);
        });
      }

      const res = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ question: message })
      });

      if (!res.ok) {
        throw new Error("Gagal menghubungi server (status " + res.status + ")");
      }

      return res.json(); // { answer: "...", ... }
    }

    /* Alur utama saat user bertanya */
    async function handleAsk(message) {
      /* Main event: submit user question */
      const trimmed = message.trim();
      if (!trimmed) return;

      userInput.value = "";
      showChatSection();

      /* Session management: create or reuse conversation */
      let conv;
      if (activeConversationIndex === null) {
        const title = trimmed.length > 30 ? trimmed.slice(0, 30) + "..." : trimmed;
        conv = { title: title || "Chat baru", messages: [] };
        conversations.unshift(conv);
        activeConversationIndex = 0;
        renderConversationList();
      } else {
        conv = conversations[activeConversationIndex];
        if (!conv.title) {
          conv.title = trimmed.length > 30 ? trimmed.slice(0, 30) + "..." : trimmed;
          renderConversationList();
        }
      }

      /* State update: append user message */
      conv.messages.push({ role: "user", content: trimmed });
      addMessageToUI("user", trimmed);

      /* UI: temporary typing bubble */
      const typingBubble = addMessageToUI(
        "assistant",
        "Sedang mengetik...",
        { typing: true }
      );
      const typingRow = typingBubble.parentElement;

      try {
        const data = await callChatApi(trimmed);
        const rawAnswer =
          (data && (data.body || data.answer || data.response)) || "";
        const answerText = toPlainText(
          rawAnswer || "Maaf, tidak ada jawaban yang tersedia."
        );

        conv.messages.push({ role: "assistant", content: answerText });

        /* UX: typing effect then feedback bar */
        typeText(typingBubble, answerText, () => {
          createFeedbackRow(typingRow, answerText);
        });
      } catch (err) {
        const errorText = "Tidak dapat terhubung ke server: " + err.message;
        conv.messages.push({ role: "assistant", content: errorText });
        typingBubble.textContent = errorText;
        createFeedbackRow(typingRow, errorText);
      }
    }

    /* Event: click conversation list */
    conversationList.addEventListener("click", (e) => {
      const item = e.target.closest(".conversation-item");
      if (!item) return;

      const index = Number(item.dataset.index);
      const conv = conversations[index];
      if (!conv) return;

      activeConversationIndex = index;
      renderConversationList();
      showChatSection();

      /* UI: render messages for selected session */
      chatContent.innerHTML = "";
      conv.messages.forEach((msg) => {
        const bubble = addMessageToUI(msg.role, msg.content, { skipScroll: true });
        if (msg.role === "assistant") {
          const row = bubble.parentElement;
          createFeedbackRow(row, msg.content);
        }
      });

      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: "auto"
      });
    });

    /* Event: submit via form */
    chatForm.addEventListener("submit", (e) => {
      e.preventDefault();
      handleAsk(userInput.value);
    });

    /* Event: FAQ chip quick question */
    faqChips.addEventListener("click", (e) => {
      if (!e.target.classList.contains("chip")) return;
      handleAsk(e.target.textContent);
    });

    /* Event: open settings overlay */
    settingsBtn.addEventListener("click", () => {
      settingsOverlay.style.display = "flex";
    });

    /* Event: close overlay by backdrop */
    settingsOverlay.addEventListener("click", (e) => {
      if (e.target === settingsOverlay) {
        settingsOverlay.style.display = "none";
      }
    });

    /* Event: close overlay via button */
    closeSettings.addEventListener("click", () => {
      settingsOverlay.style.display = "none";
    });

    /* Event: start new chat (keep history) */
    newChatBtn.addEventListener("click", () => {
      welcomeSection.style.display = "flex";
      chatContent.style.display = "none";
      chatContent.innerHTML = "";
      userInput.value = "";

      document.querySelectorAll(".conversation-item").forEach((item) => {
        item.classList.remove("active");
      });

      activeConversationIndex = null;
    });

    if (historyToggleBtn) {
      historyToggleBtn.addEventListener("click", () => {
        conversationList.classList.toggle("open");
      });
    }

    /* Initial state: show welcome only */
    welcomeSection.style.display = "flex";
    chatContent.style.display = "none";

    // ===== BAHASA =====
    let currentLang = 'id'; // default bahasa

    const translations = {
      id: {
        welcomeTitle: "Selamat Datang di Chatbot Wisata Kabupaten Klungkung",
        newChatBtn: "+ Chat baru",
        chatHistory: "Chat terakhir",
        settings: "Pengaturan",
        userLabel: "User 1",
        chatbotName: "Chatbot Klungkung",
        faq: "FAQ",
        placeholder: "Tanyakan apa saja tentang wisata di Kabupaten Klungkung...",
        hint: "Tekan Enter untuk mengirim pesan",
        logout: "Log out",
        close: "Tutup",
        back: "Kembali",
        settingsTab: "Bahasa",
        settingsHeading: "Bahasa",
        settingsLangLabel: "Pilih bahasa",
        settingsLangId: "Indonesia",
        settingsLangEn: "English",
        feedbackLike: "Suka",
        feedbackDislike: "Tidak suka",
        feedbackCopy: "Salin jawaban",
        chipRute: "Rute Utama Wisata",
        chipPesawat: "Pesawat Menuju Klungkung",
        chipWisata: "Wisata Kabupaten Klungkung",
        chipTransportasi: "Transportasi Umum",
        titleUser: "User 1",
        titleBot: "Chatbot Klungkung"
      },
      en: {
        welcomeTitle: "Welcome to Kelungkung Tourism Chatbot",
        newChatBtn: "+ New Chat",
        chatHistory: "Recent Chats",
        settings: "Settings",
        userLabel: "User 1",
        chatbotName: "Klungkung Chatbot",
        faq: "FAQ",
        placeholder: "Ask anything about tourism in Klungkung Regency...",
        hint: "Press Enter to send message",
        logout: "Log out",
        close: "Close",
        back: "Back",
        settingsTab: "Language",
        settingsHeading: "Language",
        settingsLangLabel: "Choose language",
        settingsLangId: "Indonesia",
        settingsLangEn: "English",
        feedbackLike: "Like",
        feedbackDislike: "Dislike",
        feedbackCopy: "Copy answer",
        chipRute: "Main Tourist Routes",
        chipPesawat: "Flights to Klungkung",
        chipWisata: "Klungkung Regency Tourism",
        chipTransportasi: "Public Transportation",
        titleUser: "User 1",
        titleBot: "Klungkung Chatbot"
      }
    };

    function updateUIWithLanguage(lang) {
      /* UI: apply language strings */
      const t = translations[lang];

      // Update static text elements
      document.querySelector('.sidebar-header').textContent = t.chatbotName;
      document.getElementById('newChatBtn').textContent = t.newChatBtn;
      document.querySelector('.sidebar-section-title').textContent = t.chatHistory;
      document.querySelector('#settingsBtn span:last-child').textContent = t.settings;
      const titleUser = document.querySelector('.answer-title');
      if (titleUser) {
        titleUser.textContent = t.titleUser;
      }
      const topTitle = document.getElementById('chatTopTitle');
      if (topTitle) {
        topTitle.textContent = t.titleBot;
      }
      document.querySelector('.faq-header span').textContent = t.faq;
      document.getElementById('userInput').placeholder = t.placeholder;
      document.querySelector('.hint-text').textContent = t.hint;
      document.getElementById('closeSettings').textContent = t.close;
      document.getElementById('chatBackBtn').textContent = "< " + t.back;
      document.getElementById('settingsTabLabel').textContent = t.settingsTab;
      document.getElementById('settingsHeading').textContent = t.settingsHeading;
      document.getElementById('settingsLangLabel').textContent = t.settingsLangLabel;
      document.getElementById('settingsLangId').textContent = t.settingsLangId;
      document.getElementById('settingsLangEn').textContent = t.settingsLangEn;

      // Update FAQ chips
      const chips = document.querySelectorAll('.chip');
      if (chips.length >= 4) {
          chips[0].textContent = t.chipRute;
          chips[1].textContent = t.chipPesawat;
          chips[2].textContent = t.chipWisata;
          chips[3].textContent = t.chipTransportasi;
      }

      // Update active language button UI
      const btnId = document.getElementById('lang-id');
      const btnEn = document.getElementById('lang-en');
      const settingsBtnId = document.getElementById('settingsLangId');
      const settingsBtnEn = document.getElementById('settingsLangEn');
      
      if (lang === 'id') {
          btnId.classList.add('active');
          btnEn.classList.remove('active');
          settingsBtnId.classList.add('active');
          settingsBtnEn.classList.remove('active');
      } else {
          btnEn.classList.add('active');
          btnId.classList.remove('active');
          settingsBtnEn.classList.add('active');
          settingsBtnId.classList.remove('active');
      }

      // Updated for text masking
      const welcomeTxt = document.querySelector('.welcome-text-masked');
      if (welcomeTxt) {
        welcomeTxt.textContent = t.welcomeTitle;
      }

      // Re-render conversation titles if needed
      renderConversationList();
    }

    function toggleLanguage(lang) {
      /* Event: toggle language */
      if (currentLang === lang) return;
      currentLang = lang;
      updateUIWithLanguage(lang);
    }

    /* Initial language apply */
    updateUIWithLanguage(currentLang);

    /* Event: language buttons */
    document.getElementById('lang-id').addEventListener('click', () => toggleLanguage('id'));
    document.getElementById('lang-en').addEventListener('click', () => toggleLanguage('en'));
    document.getElementById('settingsLangId').addEventListener('click', () => toggleLanguage('id'));
    document.getElementById('settingsLangEn').addEventListener('click', () => toggleLanguage('en'));

    /* Event: back button (fullscreen only) */
    const backBtn = document.getElementById('chatBackBtn');
    if (backBtn) {
      if (isWidget) {
        backBtn.style.display = "none";
      }
      backBtn.addEventListener('click', () => {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          window.location.href = "/";
        }
      });
    }

  </script>
</body>
</html>
